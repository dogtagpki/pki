sudo: required
language: python

services:
  - docker
cache: pip

jobs:
  include:
    - env: TASK_TO_RUN="pki-test"
      before_install: 
        - set -a && source .travis_global_variables
        - echo -e $gerrit_ssh_key >> ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
      install: ./.travis_init_task.sh | tee /dev/tty | grep -Eo '(http|https)://transfer.sh/[a-zA-Z0-9./?=_-]*.txt' | uniq >> ${TRANSFER_SH_URLS}
      script: travis_wait 20 ./.travis_run_task.sh | tee /dev/tty | grep -Eo '(http|https)://transfer.sh/[a-zA-Z0-9./?=_-]*.txt' | uniq >> ${TRANSFER_SH_URLS}
      after_failure: 
        - MESSAGE="$(printf 'Build Failed\nLogs:\n' )"$'\n'"$(cat ${TRANSFER_SH_URLS})"
        - > 
          ssh -p 29418 pki-jenkins-bot@review.gerrithub.io
          -o StrictHostKeyChecking=no
          gerrit review ${TRAVIS_COMMIT}
          --verified -1 
          --message "'${MESSAGE}'"
      after_script: 
        - MESSAGE="$(printf 'Build Failed\nLogs:\n' )"$'\n'"$(cat ${TRANSFER_SH_URLS})"
        - echo "${MESSAGE}"
        - docker kill ${CONTAINER}
        - docker rm ${CONTAINER}

    - env: TASK_TO_RUN="ipa-test"
      before_install: 
        - set -a && source .travis_global_variables
        - echo -e $gerrit_ssh_key >> ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
      install: ./.travis_init_task.sh
      script: travis_wait 20 ./.travis_run_task.sh
      after_script:
        - MESSAGE="$(printf 'Build Failed\nLogs:\n' )"$'\n'"$(cat ${TRANSFER_SH_URLS})"
        - echo "${MESSAGE}"
        - docker kill ${CONTAINER}
        - docker rm ${CONTAINER}
      after_failure:
        - docker exec ${CONTAINER} journalctl  -l > ${PKI_LOG}
        - echo "Uploading CI Logs to transfer.sh ..."
        - curl --upload-file ./${PKI_LOG} https://transfer.sh/dogtag_build_logs.txt >> ${TRANSFER_SH_URLS}
        - curl --upload-file ./${CI_RESULTS_LOG} https://transfer.sh/freeipa-integration.txt >> ${TRANSFER_SH_URLS}
        - MESSAGE="$(printf 'Build Failed\nLogs:\n' )"$'\n'"$(cat ${TRANSFER_SH_URLS})"
        - > 
          ssh -p 29418 pki-jenkins-bot@review.gerrithub.io
          -o StrictHostKeyChecking=no
          gerrit review ${TRAVIS_COMMIT}
          --verified -1 
          --message "'${MESSAGE}'"

    - stage: Verification Label
      before_install: echo -e $gerrit_ssh_key >> ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
      script: 
        - > 
          ssh -p 29418 pki-jenkins-bot@review.gerrithub.io
          -o StrictHostKeyChecking=no
          gerrit review ${TRAVIS_COMMIT}
          --verified +1 
          --message 'Build\ Successful.'
