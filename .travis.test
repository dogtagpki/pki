#!/bin/bash
set -ex

WORKDIR="${BUILDDIR:-/tmp/builddir}"
BUILDUSER=builduser
BUILDUSER_UID=${UID:-1000}
BUILDUSER_GID=${GID:-1000}

. /etc/os-release

echo "$NAME $VERSION $1"

## compose_pki_core_packages doesn't run as root, create a build user
groupadd --non-unique -g $BUILDUSER_GID ${BUILDUSER}
useradd --non-unique -u $BUILDUSER_UID -g $BUILDUSER_GID ${BUILDUSER}

## chown workdir and enter pki dir
chown ${BUILDUSER}:${BUILDUSER} ${WORKDIR}
cd ${WORKDIR}/pki

## prepare additional build dependencies
dnf copr -y enable @pki/10.4
dnf builddep -y ./specs/pki-core.spec

# update, container might be outdated
dnf update -y

## run tox and build
# run make with --quiet to reduce log verbosity. Travis CI has a log limit
# of 10,000 lines.
sudo -u ${BUILDUSER} MAKEFLAGS="-j2 --quiet" -s -- ./scripts/compose_pki_core_packages rpms
