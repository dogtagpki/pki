name: CA with Sequential Serial Numbers
#
# This test creates a CA subsystem with sequential serial numbers
# for certs and requests, performs enrollments, and verifies that
# the number ranges are maintained properly in CS.cfg and DS.

on: workflow_call

env:
  DS_IMAGE: ${{ vars.DS_IMAGE || 'quay.io/389ds/dirsrv' }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      SHARED: /tmp/workdir/pki
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Retrieve PKI images
        uses: actions/cache@v4
        with:
          key: pki-images-${{ github.sha }}
          path: pki-images.tar

      - name: Load PKI images
        run: docker load --input pki-images.tar

      - name: Create network
        run: docker network create example

      ####################################################################################################
      # Create CA with Sequential Serial Numbers
      #
      # requests:
      # - range: 1 - 10 decimal
      # - increment: 10 decimal
      # - minimum: 5 decimal
      # certs:
      # - range: 1 - 10 hex (1 - 16 decimal)
      # - increment: 10 hex (16 decimal)
      # - minimum: 8 decimal

      - name: Set up DS container
        run: |
          tests/bin/ds-create.sh \
              --image=${{ env.DS_IMAGE }} \
              --hostname=ds.example.com \
              --network=example \
              --network-alias=ds.example.com \
              --password=Secret.123 \
              ds

      - name: Set up PKI container
        run: |
          tests/bin/runner-init.sh \
              --hostname=pki.example.com \
              --network=example \
              --network-alias=pki.example.com \
              pki

      - name: Create CA
        run: |
          docker exec pki pkispawn \
              -f /usr/share/pki/server/examples/installation/ca.cfg \
              -s CA \
              -D pki_ds_url=ldap://ds.example.com:3389 \
              -D pki_request_id_generator=legacy \
              -D pki_request_number_range_start=1 \
              -D pki_request_number_range_end=10 \
              -D pki_request_number_range_increment=10 \
              -D pki_request_number_range_minimum=5 \
              -D pki_request_number_range_transfer=5 \
              -D pki_cert_id_generator=legacy \
              -D pki_serial_number_range_start=1 \
              -D pki_serial_number_range_end=10 \
              -D pki_serial_number_range_increment=10 \
              -D pki_serial_number_range_minimum=8 \
              -D pki_serial_number_range_transfer=8 \
              -v

      - name: Check requests
        run: |
          docker exec pki pki-server ca-cert-request-find | tee output

          sed -n "s/^ *Request ID: *\(.*\)$/\1/p" output > actual

          # there should be 6 requests
          seq 1 6 > expected

          diff expected actual

      - name: Check certs
        run: |
          docker exec pki pki-server ca-cert-find | tee output

          sed -n "s/^ *Serial Number: *\(.*\)$/\1/p" output > actual

          # there should be 6 certs
          seq 1 6 | while read n; do printf "0x%x\n" $n; done > expected

          diff expected actual

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be 1 - 10 decimal (total: 10, remaining: 4)
          cat > expected << EOF
          dbs.beginRequestNumber=1
          dbs.endRequestNumber=10
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be 1 - 10 hex (total: 16, remaining: 10)
          cat > expected << EOF
          dbs.beginSerialNumber=1
          dbs.endSerialNumber=10
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be incremented by 10 decimal to 11
          cat > expected << EOF
          nextRange: 11
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # ideally, cert nextRange should be incremented by 10 hex (16 decimal)
          # to 11 hex (17 decimal), but currently the attribute is always read
          # as decimal in:
          # - Repository.getNextRange()
          # - SubsystemRangeUpdateCLI.updateSerialNumberRange()
          cat > expected << EOF
          nextRange: 11
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          # serial number management is disabled so there are no range objects created
          diff /dev/null output

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          # serial number management is disabled so there are no range objects created
          diff /dev/null output

      ####################################################################################################
      # Enable serial number management
      #
      # Restarting PKI server with serial management enabled will trigger
      # a new range allocation for requests since the remaining numbers in
      # the current range (i.e. 4) is below the minimum (i.e. 5).
      #
      # For certs there is no new allocation since the remaining numbers
      # in the current range (i.e. 10) is still above the minimum (i.e. 8).

      - name: Enable serial number management
        run: |
          docker exec pki pki-server ca-config-set dbs.enableSerialManagement true

          # disable serial number update background task
          docker exec pki pki-server ca-config-set ca.serialNumberUpdateInterval 0

          # enable serial number update manual job
          docker exec pki pki-server ca-config-set jobsScheduler.enabled true
          docker exec pki pki-server ca-config-set jobsScheduler.job.serialNumberUpdate.enabled true

          # restart CA subsystem
          docker exec pki pki-server ca-redeploy --wait

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be 1 - 10 decimal (total: 10, remaining: 4)
          cat > expected << EOF
          dbs.beginRequestNumber=1
          dbs.endRequestNumber=10
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be 1 - 10 hex (total: 16, remaining: 10)
          cat > expected << EOF
          dbs.beginSerialNumber=1
          dbs.endSerialNumber=10
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be incremented by 10 decimal
          cat > expected << EOF
          nextRange: 21
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRange should be the same
          cat > expected << EOF
          nextRange: 11
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e SecurePort: \
              -e beginRange: \
              -e endRange: \
              -e host: \
              output \
              | sort > actual

          # new request range should be 11 - 20 decimal (total: 10)
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com
          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          # there should be no new cert range
          diff /dev/null output

      ####################################################################################################
      # Enroll 10 certs
      #
      # This will create 10 requests and 10 certs. For requests, since
      # the remaining numbers in the current range is below the minimum,
      # it will automatically switch to the new range.
      #
      # For certs, it will exhaust the current range but not switch to a
      # new range.

      - name: Install admin cert
        run: |
          docker exec pki pki-server cert-export \
              --cert-file ca_signing.crt \
              ca_signing

          docker exec pki pki nss-cert-import \
              --cert ca_signing.crt \
              --trust CT,C,C \
              ca_signing

          docker exec pki pki pkcs12-import \
              --pkcs12 /root/.dogtag/pki-tomcat/ca_admin_cert.p12 \
              --pkcs12-password Secret.123

      - name: Enroll 10 certs
        run: |
          docker exec pki pki \
              nss-cert-request \
              --subject "uid=testuser" \
              --ext /usr/share/pki/tools/examples/certs/testuser.conf \
              --csr testuser.csr

          for i in $(seq 1 10); do
              docker exec pki pki \
                  -n caadmin \
                  ca-cert-issue \
                  --profile caUserCert \
                  --csr-file testuser.csr \
                  --output-file testuser.crt

              docker exec pki openssl x509 -in testuser.crt -serial -noout
          done

      - name: Check requests
        run: |
          docker exec pki pki-server ca-cert-request-find | tee output

          sed -n "s/^ *Request ID: *\(.*\)$/\1/p" output > actual

          # there should be 16 requests
          seq 1 16 > expected

          diff expected actual

      - name: Check certs
        run: |
          docker exec pki pki-server ca-cert-find | tee output

          sed -n "s/^ *Serial Number: *\(.*\)$/\1/p" output > actual

          # there should be 16 certs
          seq 1 16 | while read n; do printf "0x%x\n" $n; done > expected

          diff expected actual

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be 11 - 20 decimal (total: 10, remaining: 4)
          cat > expected << EOF
          dbs.beginRequestNumber=11
          dbs.endRequestNumber=20
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be 1 - 10 hex (total: 16, remaining: 0)
          cat > expected << EOF
          dbs.beginSerialNumber=1
          dbs.endSerialNumber=10
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be the same
          cat > expected << EOF
          nextRange: 21
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRange should be the same
          cat > expected << EOF
          nextRange: 11
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e SecurePort: \
              -e beginRange: \
              -e endRange: \
              -e host: \
              output \
              | sort > actual

          # request range objects should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com
          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          # cert range objects should be the same
          diff /dev/null output

      ####################################################################################################
      # Enroll a cert when cert range is exhausted
      #
      # This will create one request but fails to create another cert.
      # For some reason requests can switch to a new range automatically,
      # but certs cannot.

      - name: Enroll a cert when cert range is exhausted
        run: |
          docker exec pki pki \
              -n caadmin \
              ca-cert-issue \
              --profile caUserCert \
              --csr-file testuser.csr \
              --output-file testuser.crt \
              > >(tee stdout) 2> >(tee stderr >&2) || true

          # TODO: fix missing request ID and typo
          cat > expected << EOF
          PKIException: Server Internal Error: Request  was completed with errors.
          CA has exausted all available serial numbers
          EOF

          diff expected stderr

      - name: Check requests
        run: |
          docker exec pki pki-server ca-cert-request-find | tee output

          sed -n "s/^ *Request ID: *\(.*\)$/\1/p" output > actual

          # there should be 17 requests
          seq 1 17 > expected

          diff expected actual

      - name: Check certs
        run: |
          docker exec pki pki-server ca-cert-find | tee output

          sed -n "s/^ *Serial Number: *\(.*\)$/\1/p" output > actual

          # there should be 16 certs
          seq 1 16 | while read n; do printf "0x%x\n" $n; done > expected

          diff expected actual

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be 11 - 20 decimal (total: 10, remaining: 3)
          cat > expected << EOF
          dbs.beginRequestNumber=11
          dbs.endRequestNumber=20
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be 1 - 10 hex (total: 16, remaining: 0)
          cat > expected << EOF
          dbs.beginSerialNumber=1
          dbs.endSerialNumber=10
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be the same
          cat > expected << EOF
          nextRange: 21
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRange should be the same
          cat > expected << EOF
          nextRange: 11
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e SecurePort: \
              -e beginRange: \
              -e endRange: \
              -e host: \
              output \
              | sort > actual

          # request range objects should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com
          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          # cert range objects should be the same
          diff /dev/null output

      ####################################################################################################
      # Update serial numbers
      #
      # This will allocate new ranges for requests and certs since
      # the remaining numbers in their ranges are below the minimum.

      - name: Update serial numbers
        run: |
          docker exec pki pki -n caadmin ca-job-start serialNumberUpdate

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be the same
          cat > expected << EOF
          dbs.beginRequestNumber=11
          dbs.endRequestNumber=20
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be the same
          cat > expected << EOF
          dbs.beginSerialNumber=1
          dbs.endSerialNumber=10
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be incremented by 10 decimal to 31 decimal
          cat > expected << EOF
          nextRange: 31
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRequest should incremented by 10 hex (16 decimal) to 27 decimal
          cat > expected << EOF
          nextRange: 27
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          rm -f actual

          for DN in $(sed -n 's/^dn: *\(.*\)$/\1/p' output)
          do
              docker exec ds ldapsearch \
                  -H ldap://ds.example.com:3389 \
                  -D "cn=Directory Manager" \
                  -w Secret.123 \
                  -b $DN \
                  -s base \
                  -o ldif_wrap=no \
                  -LLL \
                  | grep \
                      -e SecurePort: \
                      -e beginRange: \
                      -e endRange: \
                      -e host: \
                  | sort >> actual

              echo >> actual
          done

          # new request range should be 21 - 30 decimal (total: 10)
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com

          SecurePort: 8443
          beginRange: 21
          endRange: 30
          host: pki.example.com

          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e SecurePort: \
              -e beginRange: \
              -e endRange: \
              -e host: \
              output \
              | sort > actual

          # new request range should be 11 - 26 decimal (total: 16)
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 26
          host: pki.example.com
          EOF

          diff expected actual

      ####################################################################################################
      # Enroll 13 additional certs
      #
      # This will create 13 requests and 13 certs. Both requests and certs
      # will switch to the new ranges allocated earlier.

      - name: Enroll 13 additional certs
        run: |
          for i in $(seq 1 13); do
              docker exec pki pki \
                  -n caadmin \
                  ca-cert-issue \
                  --profile caUserCert \
                  --csr-file testuser.csr \
                  --output-file testuser.crt

              docker exec pki openssl x509 -in testuser.crt -serial -noout
          done

      - name: Check requests
        run: |
          docker exec pki pki-server ca-cert-request-find | tee output

          sed -n "s/^ *Request ID: *\(.*\)$/\1/p" output > actual

          # there should be 30 requests (17 existing + 13 new)
          seq 1 30 > expected

          diff expected actual

      - name: Check certs
        run: |
          docker exec pki pki-server ca-cert-find | tee output

          sed -n "s/^ *Serial Number: *\(.*\)$/\1/p" output > actual

          # there should be 29 certs (16 existing + 13 new)
          seq 1 29 | while read n; do printf "0x%x\n" $n; done > expected

          diff expected actual

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be 21 - 30 decimal (total: 10, remaining: 0)
          cat > expected << EOF
          dbs.beginRequestNumber=21
          dbs.endRequestNumber=30
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be 11 - 20 hex (total: 16, remaining: 3)
          cat > expected << EOF
          dbs.beginSerialNumber=11
          dbs.endSerialNumber=20
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be the same
          cat > expected << EOF
          nextRange: 31
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRange should be the same
          cat > expected << EOF
          nextRange: 27
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          rm -f actual

          for DN in $(sed -n 's/^dn: *\(.*\)$/\1/p' output)
          do
              docker exec ds ldapsearch \
                  -H ldap://ds.example.com:3389 \
                  -D "cn=Directory Manager" \
                  -w Secret.123 \
                  -b $DN \
                  -s base \
                  -o ldif_wrap=no \
                  -LLL \
                  | grep \
                      -e SecurePort: \
                      -e beginRange: \
                      -e endRange: \
                      -e host: \
                  | sort >> actual

              echo >> actual
          done

          # request range objects should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com

          SecurePort: 8443
          beginRange: 21
          endRange: 30
          host: pki.example.com

          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e SecurePort: \
              -e beginRange: \
              -e endRange: \
              -e host: \
              output \
              | sort > actual

          # cert range objects should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 26
          host: pki.example.com
          EOF

          diff expected actual

      ####################################################################################################
      # Enroll a cert when request range is exhausted
      #
      # This will fail to create a request so no cert will be created either.

      - name: Enroll a cert when request range is exhausted
        run: |
          docker exec pki pki \
              -n caadmin \
              ca-cert-issue \
              --profile caUserCert \
              --csr-file testuser.csr \
              --output-file testuser.crt \
              > >(tee stdout) 2> >(tee stderr >&2) || true

          cat > expected << EOF
          PKIException: Unable to create enrollment request: Unable to create enrollment request: All serial numbers are used. The max serial number is 0x31
          EOF

          diff expected stderr

      - name: Check requests
        run: |
          docker exec pki pki-server ca-cert-request-find | tee output

          sed -n "s/^ *Request ID: *\(.*\)$/\1/p" output > actual

          # requests should be the same
          seq 1 30 > expected

          diff expected actual

      - name: Check certs
        run: |
          docker exec pki pki-server ca-cert-find | tee output

          sed -n "s/^ *Serial Number: *\(.*\)$/\1/p" output > actual

          # certs should be the same
          seq 1 29 | while read n; do printf "0x%x\n" $n; done > expected

          diff expected actual

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be the same
          cat > expected << EOF
          dbs.beginRequestNumber=21
          dbs.endRequestNumber=30
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be the same
          cat > expected << EOF
          dbs.beginSerialNumber=11
          dbs.endSerialNumber=20
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be the same
          cat > expected << EOF
          nextRange: 31
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRange should be the same
          cat > expected << EOF
          nextRange: 27
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          rm -f actual

          for DN in $(sed -n 's/^dn: *\(.*\)$/\1/p' output)
          do
              docker exec ds ldapsearch \
                  -H ldap://ds.example.com:3389 \
                  -D "cn=Directory Manager" \
                  -w Secret.123 \
                  -b $DN \
                  -s base \
                  -o ldif_wrap=no \
                  -LLL \
                  | grep \
                      -e SecurePort: \
                      -e beginRange: \
                      -e endRange: \
                      -e host: \
                  | sort >> actual

              echo >> actual
          done

          # request range objects should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com

          SecurePort: 8443
          beginRange: 21
          endRange: 30
          host: pki.example.com

          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e SecurePort: \
              -e beginRange: \
              -e endRange: \
              -e host: \
              output \
              | sort > actual

          # cert range objects should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 26
          host: pki.example.com
          EOF

          diff expected actual

      ####################################################################################################
      # Update serial numbers again
      #
      # This will allocate new ranges for requests and certs since
      # the remaining numbers in their ranges are below the minimum.

      - name: Update serial numbers again
        run: |
          docker exec pki pki -n caadmin ca-job-start serialNumberUpdate

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be the same
          cat > expected << EOF
          dbs.beginRequestNumber=21
          dbs.endRequestNumber=30
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be the same
          cat > expected << EOF
          dbs.beginSerialNumber=11
          dbs.endSerialNumber=20
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be incremented by 10 decimal to 41 decimal
          cat > expected << EOF
          nextRange: 41
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRange should be incremented by 10 hex (16 decimal) to 43 decimal
          cat > expected << EOF
          nextRange: 43
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          rm -f actual

          for DN in $(sed -n 's/^dn: *\(.*\)$/\1/p' output)
          do
              docker exec ds ldapsearch \
                  -H ldap://ds.example.com:3389 \
                  -D "cn=Directory Manager" \
                  -w Secret.123 \
                  -b $DN \
                  -s base \
                  -o ldif_wrap=no \
                  -LLL \
                  | grep \
                      -e SecurePort: \
                      -e beginRange: \
                      -e endRange: \
                      -e host: \
                  | sort >> actual

              echo >> actual
          done

          # new request range should be 31 - 40 decimal (total: 10)
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com

          SecurePort: 8443
          beginRange: 21
          endRange: 30
          host: pki.example.com

          SecurePort: 8443
          beginRange: 31
          endRange: 40
          host: pki.example.com

          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          rm -f actual

          for DN in $(sed -n 's/^dn: *\(.*\)$/\1/p' output)
          do
              docker exec ds ldapsearch \
                  -H ldap://ds.example.com:3389 \
                  -D "cn=Directory Manager" \
                  -w Secret.123 \
                  -b $DN \
                  -s base \
                  -o ldif_wrap=no \
                  -LLL \
                  | grep \
                      -e SecurePort: \
                      -e beginRange: \
                      -e endRange: \
                      -e host: \
                  | sort >> actual

              echo >> actual
          done

          # new cert range should be 27 - 42 decimal (total: 16)
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 26
          host: pki.example.com

          SecurePort: 8443
          beginRange: 27
          endRange: 42
          host: pki.example.com

          EOF

          diff expected actual

      ####################################################################################################
      # Enroll 10 additional certs
      #
      # This will create 10 requests and 10 certs.
      # Both requests and certs will switch to new ranges.

      - name: Enroll 10 additional certs
        run: |
          for i in $(seq 1 10); do
              docker exec pki pki \
                  -n caadmin \
                  ca-cert-issue \
                  --profile caUserCert \
                  --csr-file testuser.csr \
                  --output-file testuser.crt

              docker exec pki openssl x509 -in testuser.crt -serial -noout
          done

      - name: Check requests
        run: |
          docker exec pki pki-server ca-cert-request-find | tee output

          sed -n "s/^ *Request ID: *\(.*\)$/\1/p" output > actual

          # there should be 40 requests (30 existing + 10 new)
          seq 1 40 > expected

          diff expected actual

      - name: Check certs
        run: |
          docker exec pki pki-server ca-cert-find | tee output

          sed -n "s/^ *Serial Number: *\(.*\)$/\1/p" output > actual

          # there should be 39 certs (29 existing + 10 new)
          # but due to a bug the serial numbers have a gap

          # seq 1 39 | while read n; do printf "0x%x\n" $n; done > expected
          seq 1 32 | while read n; do printf "0x%x\n" $n; done > expected
          seq 39 45 | while read n; do printf "0x%x\n" $n; done >> expected

          diff expected actual

      - name: Check request range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginRequestNumber \
                  -e dbs.endRequestNumber \
                  -e dbs.requestCloneTransferNumber \
                  -e dbs.requestIncrement \
                  -e dbs.requestLowWaterMark \
              | tee actual

          # request range should be 31 - 40 decimal (total: 10, remaining: 0)
          cat > expected << EOF
          dbs.beginRequestNumber=31
          dbs.endRequestNumber=40
          dbs.requestCloneTransferNumber=5
          dbs.requestIncrement=10
          dbs.requestLowWaterMark=5
          EOF

          diff expected actual

      - name: Check cert range config
        run: |
          docker exec pki pki-server ca-config-find \
              | grep \
                  -e dbs.beginSerialNumber \
                  -e dbs.endSerialNumber \
                  -e dbs.serialCloneTransferNumber \
                  -e dbs.serialIncrement \
                  -e dbs.serialLowWaterMark \
              | tee actual

          # cert range should be 21 - 30 hex (total: 16, remaining: 0)
          cat > expected << EOF
          dbs.beginSerialNumber=27
          dbs.endSerialNumber=36
          dbs.serialCloneTransferNumber=8
          dbs.serialIncrement=10
          dbs.serialLowWaterMark=8
          EOF

          diff expected actual

      - name: Check request repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=ca,ou=requests,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # request nextRange should be the same
          cat > expected << EOF
          nextRange: 41
          serialno: 010
          EOF

          diff expected actual

      - name: Check cert repository
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ca,dc=ca,dc=pki,dc=example,dc=com \
              -s base \
              -o ldif_wrap=no \
              -LLL | tee output

          grep \
              -e serialno: \
              -e nextRange: \
              output \
              | sort > actual

          # cert nextRange should be the same
          cat > expected << EOF
          nextRange: 43
          serialno: 011
          EOF

          diff expected actual

      - name: Check request range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=requests,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          rm -f actual

          for DN in $(sed -n 's/^dn: *\(.*\)$/\1/p' output)
          do
              docker exec ds ldapsearch \
                  -H ldap://ds.example.com:3389 \
                  -D "cn=Directory Manager" \
                  -w Secret.123 \
                  -b $DN \
                  -s base \
                  -o ldif_wrap=no \
                  -LLL \
                  | grep \
                      -e SecurePort: \
                      -e beginRange: \
                      -e endRange: \
                      -e host: \
                  | sort >> actual

              echo >> actual
          done

          # request range objects should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 20
          host: pki.example.com

          SecurePort: 8443
          beginRange: 21
          endRange: 30
          host: pki.example.com

          SecurePort: 8443
          beginRange: 31
          endRange: 40
          host: pki.example.com

          EOF

          diff expected actual

      - name: Check cert range objects
        run: |
          docker exec ds ldapsearch \
              -H ldap://ds.example.com:3389 \
              -D "cn=Directory Manager" \
              -w Secret.123 \
              -b ou=certificateRepository,ou=ranges,dc=ca,dc=pki,dc=example,dc=com \
              -s one \
              -o ldif_wrap=no \
              -LLL | tee output

          rm -f actual

          for DN in $(sed -n 's/^dn: *\(.*\)$/\1/p' output)
          do
              docker exec ds ldapsearch \
                  -H ldap://ds.example.com:3389 \
                  -D "cn=Directory Manager" \
                  -w Secret.123 \
                  -b $DN \
                  -s base \
                  -o ldif_wrap=no \
                  -LLL \
                  | grep \
                      -e SecurePort: \
                      -e beginRange: \
                      -e endRange: \
                      -e host: \
                  | sort >> actual

              echo >> actual
          done

          # cert range should be the same
          cat > expected << EOF
          SecurePort: 8443
          beginRange: 11
          endRange: 26
          host: pki.example.com

          SecurePort: 8443
          beginRange: 27
          endRange: 42
          host: pki.example.com

          EOF

          diff expected actual

      ####################################################################################################
      # Enroll a cert with RSNv3
      #
      # This should create a request and a cert. The cert
      # should be issued with a non-sequential serial number.

      - name: Switch to RSNv3
        run: |
          # switch cert request ID generator to RSNv3
          docker exec pki pki-server ca-config-unset dbs.beginRequestNumber
          docker exec pki pki-server ca-config-unset dbs.endRequestNumber
          docker exec pki pki-server ca-config-unset dbs.requestIncrement
          docker exec pki pki-server ca-config-unset dbs.requestLowWaterMark
          docker exec pki pki-server ca-config-unset dbs.requestCloneTransferNumber
          docker exec pki pki-server ca-config-unset dbs.requestRangeDN

          docker exec pki pki-server ca-config-set dbs.request.id.generator random

          # switch cert ID generator to RSNv3
          docker exec pki pki-server ca-config-unset dbs.beginSerialNumber
          docker exec pki pki-server ca-config-unset dbs.endSerialNumber
          docker exec pki pki-server ca-config-unset dbs.serialIncrement
          docker exec pki pki-server ca-config-unset dbs.serialLowWaterMark
          docker exec pki pki-server ca-config-unset dbs.serialCloneTransferNumber
          docker exec pki pki-server ca-config-unset dbs.serialRangeDN

          docker exec pki pki-server ca-config-set dbs.cert.id.generator random

          # restart CA subsystem
          docker exec pki pki-server ca-redeploy --wait

      - name: Enroll a cert with RSNv3
        run: |
          docker exec pki pki \
              -n caadmin \
              ca-cert-issue \
              --profile caUserCert \
              --csr-file testuser.csr \
              --output-file testuser.crt

          docker exec pki openssl x509 -in testuser.crt -serial -noout

      - name: Check requests
        run: |
          docker exec pki pki-server ca-cert-request-find | tee output
          sed -n "s/^ *Request ID: *\(.*\)$/\1/p" output > list

          # there should be 40 requests with sequential request ID
          seq 1 40 > expected
          head -n 40 list > actual
          diff expected actual

          # there should be one request with random request ID (longer than 2 chars)
          REQUEST_ID=$(tail -n 1 list)
          [ ${#REQUEST_ID} -gt 2 ]

      - name: Check certs
        run: |
          docker exec pki pki-server ca-cert-find | tee output
          sed -n "s/^ *Serial Number: *\(.*\)$/\1/p" output > list

          # there should be 39 certs with sequential serial numbers
          # but due to a bug the serial numbers have a gap

          # seq 1 39 | while read n; do printf "0x%x\n" $n; done > expected
          seq 1 32 | while read n; do printf "0x%x\n" $n; done > expected
          seq 39 45 | while read n; do printf "0x%x\n" $n; done >> expected
          head -n 39 list > actual
          diff expected actual

          # there should be one cert with random serial number (longer than 4 chars)
          SERIAL_NUMBER=$(tail -n 1 list)
          [ ${#SERIAL_NUMBER} -gt 4 ]

      ####################################################################################################
      # Cleanup

      - name: Remove CA
        run: docker exec pki pkidestroy -s CA -v

      - name: Check DS server systemd journal
        if: always()
        run: |
          docker exec ds journalctl -x --no-pager -u dirsrv@localhost.service

      - name: Check DS container logs
        if: always()
        run: |
          docker logs ds

      - name: Check PKI server systemd journal
        if: always()
        run: |
          docker exec pki journalctl -x --no-pager -u pki-tomcatd@pki-tomcat.service

      - name: Check PKI server access log
        if: always()
        run: |
          docker exec pki find /var/log/pki/pki-tomcat -name "localhost_access_log.*" -exec cat {} \;

      - name: Check CA debug log
        if: always()
        run: |
          docker exec pki find /var/lib/pki/pki-tomcat/logs/ca -name "debug.*" -exec cat {} \;
