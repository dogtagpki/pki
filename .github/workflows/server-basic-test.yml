name: Basic server
# https://github.com/dogtagpki/pki/wiki/PKI-Server-CLI

on: workflow_call

env:
  DS_IMAGE: ${{ vars.DS_IMAGE || 'quay.io/389ds/dirsrv' }}

jobs:
  # docs/installation/server/Installing_Basic_PKI_Server.md
  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      SHARED: /tmp/workdir/pki
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Retrieve PKI images
        uses: actions/cache@v4
        with:
          key: pki-images-${{ github.sha }}
          path: pki-images.tar

      - name: Load PKI images
        run: docker load --input pki-images.tar

      - name: Create network
        run: docker network create example

      - name: Set up server container
        run: |
          tests/bin/runner-init.sh \
              --hostname=pki.example.com \
              --network=example \
              --network-alias=pki.example.com \
              pki

          # get Fedora version
          FEDORA_VERSION=$(docker exec pki sed -n 's/^VERSION_ID=//p' /etc/os-release)
          echo "FEDORA_VERSION=$FEDORA_VERSION" >> $GITHUB_ENV

      - name: Check Tomcat lib dir
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /usr/share/java/tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

      - name: Check PKI lib dir
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /usr/share/pki/lib \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # the following libraries should be bundled:
          # - commons-cli
          # - commons-codec
          # - commons-io
          # - commons-lang3
          # - commons-logging
          # - commons-net
          # - httpclient
          # - httpcore
          # - jackson-annotations
          # - jackson-core
          # - jackson-databind
          # - jackson-jaxrs-base
          # - jackson-jaxrs-json-provider
          # - jackson-module-jaxb-annotations
          # - jakarta.activation-api
          # - jakarta.annotation-api
          # - jakarta.xml.bind-api
          # - jboss-jaxrs-api_2.0_spec
          # - jboss-logging
          # - resteasy-client
          # - resteasy-jackson2-provider
          # - resteasy-jaxrs
          # - slf4j-api
          # - slf4j-jdk14
          cat > expected << EOF
          -rw-r--r-- root root commons-cli-x.y.z.jar
          lrwxrwxrwx root root commons-cli.jar -> commons-cli-x.y.z.jar
          -rw-r--r-- root root commons-codec-x.y.z.jar
          lrwxrwxrwx root root commons-codec.jar -> commons-codec-x.y.z.jar
          -rw-r--r-- root root commons-io-x.y.z.jar
          lrwxrwxrwx root root commons-io.jar -> commons-io-x.y.z.jar
          -rw-r--r-- root root commons-lang3-x.y.z.jar
          lrwxrwxrwx root root commons-lang3.jar -> commons-lang3-x.y.z.jar
          -rw-r--r-- root root commons-logging-x.y.z.jar
          lrwxrwxrwx root root commons-logging.jar -> commons-logging-x.y.z.jar
          -rw-r--r-- root root commons-net-x.y.z.jar
          lrwxrwxrwx root root commons-net.jar -> commons-net-x.y.z.jar
          -rw-r--r-- root root httpclient-x.y.z.jar
          lrwxrwxrwx root root httpclient.jar -> httpclient-x.y.z.jar
          -rw-r--r-- root root httpcore-x.y.z.jar
          lrwxrwxrwx root root httpcore.jar -> httpcore-x.y.z.jar
          -rw-r--r-- root root jackson-annotations-x.y.z.jar
          lrwxrwxrwx root root jackson-annotations.jar -> jackson-annotations-x.y.z.jar
          -rw-r--r-- root root jackson-core-x.y.z.jar
          lrwxrwxrwx root root jackson-core.jar -> jackson-core-x.y.z.jar
          -rw-r--r-- root root jackson-databind-x.y.z.jar
          lrwxrwxrwx root root jackson-databind.jar -> jackson-databind-x.y.z.jar
          -rw-r--r-- root root jackson-jaxrs-base-x.y.z.jar
          lrwxrwxrwx root root jackson-jaxrs-base.jar -> jackson-jaxrs-base-x.y.z.jar
          -rw-r--r-- root root jackson-jaxrs-json-provider-x.y.z.jar
          lrwxrwxrwx root root jackson-jaxrs-json-provider.jar -> jackson-jaxrs-json-provider-x.y.z.jar
          -rw-r--r-- root root jackson-module-jaxb-annotations-x.y.z.jar
          lrwxrwxrwx root root jackson-module-jaxb-annotations.jar -> jackson-module-jaxb-annotations-x.y.z.jar
          -rw-r--r-- root root jakarta.activation-api-x.y.z.jar
          lrwxrwxrwx root root jakarta.activation-api.jar -> jakarta.activation-api-x.y.z.jar
          -rw-r--r-- root root jakarta.annotation-api-x.y.z.jar
          lrwxrwxrwx root root jakarta.annotation-api.jar -> jakarta.annotation-api-x.y.z.jar
          -rw-r--r-- root root jakarta.xml.bind-api-x.y.z.jar
          lrwxrwxrwx root root jakarta.xml.bind-api.jar -> jakarta.xml.bind-api-x.y.z.jar
          -rw-r--r-- root root jboss-jaxrs-api_2.0_spec-x.y.z.Final.jar
          lrwxrwxrwx root root jboss-jaxrs-api_2.0_spec.jar -> jboss-jaxrs-api_2.0_spec-x.y.z.Final.jar
          -rw-r--r-- root root jboss-logging-x.y.z.Final.jar
          lrwxrwxrwx root root jboss-logging.jar -> jboss-logging-x.y.z.Final.jar
          lrwxrwxrwx root root jss.jar -> ../../../../usr/lib/java/jss.jar
          lrwxrwxrwx root root ldapjdk.jar -> ../../../../usr/share/java/ldapjdk.jar
          lrwxrwxrwx root root p11-kit-trust.so -> ../../../../usr/lib64/pkcs11/p11-kit-trust.so
          lrwxrwxrwx root root pki-common.jar -> ../../../../usr/share/java/pki/pki-common.jar
          lrwxrwxrwx root root pki-tools.jar -> ../../../../usr/share/java/pki/pki-tools.jar
          -rw-r--r-- root root resteasy-client-x.y.z.Final.jar
          -rw-r--r-- root root resteasy-jackson2-provider-x.y.z.Final.jar
          lrwxrwxrwx root root resteasy-jackson2-provider.jar -> resteasy-jackson2-provider-x.y.z.Final.jar
          -rw-r--r-- root root resteasy-jaxrs-x.y.z.Final.jar
          lrwxrwxrwx root root resteasy-jaxrs.jar -> resteasy-jaxrs-x.y.z.Final.jar
          lrwxrwxrwx root root servlet.jar -> ../../../../usr/share/java/tomcat-servlet-api.jar
          -rw-r--r-- root root slf4j-api-x.y.z.jar
          lrwxrwxrwx root root slf4j-api.jar -> slf4j-api-x.y.z.jar
          -rw-r--r-- root root slf4j-jdk14-x.y.z.jar
          lrwxrwxrwx root root slf4j-jdk14.jar -> slf4j-jdk14-x.y.z.jar
          EOF

          # normalize actual result:
          # - replace version number with x.y.z
          # - replace servlet.jar with tomcat-servlet-api.jar
          sed -e 's/-[0-9]*\.[0-9]*\.[0-9]*\.jar$/-x.y.z.jar/' \
              -e 's/-[0-9]*\.[0-9]*\.[0-9]*\.Final\.jar$/-x.y.z.Final.jar/' \
              -e 's/\/servlet.jar$/\/tomcat-servlet-api.jar/' \
              output > actual

          diff expected actual

      - name: Check PKI server common lib dir
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /usr/share/pki/server/common/lib \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # the following libraries should be bundled:
          # - resteasy-servlet-initializer
          cat > expected << EOF
          lrwxrwxrwx root root commons-codec.jar -> ../../../lib/commons-codec.jar
          lrwxrwxrwx root root commons-io.jar -> ../../../lib/commons-io.jar
          lrwxrwxrwx root root commons-lang3.jar -> ../../../lib/commons-lang3.jar
          lrwxrwxrwx root root commons-logging.jar -> ../../../lib/commons-logging.jar
          lrwxrwxrwx root root commons-net.jar -> ../../../lib/commons-net.jar
          lrwxrwxrwx root root httpclient.jar -> ../../../lib/httpclient.jar
          lrwxrwxrwx root root httpcore.jar -> ../../../lib/httpcore.jar
          lrwxrwxrwx root root jackson-annotations.jar -> ../../../lib/jackson-annotations.jar
          lrwxrwxrwx root root jackson-core.jar -> ../../../lib/jackson-core.jar
          lrwxrwxrwx root root jackson-databind.jar -> ../../../lib/jackson-databind.jar
          lrwxrwxrwx root root jackson-jaxrs-base.jar -> ../../../lib/jackson-jaxrs-base.jar
          lrwxrwxrwx root root jackson-jaxrs-json-provider.jar -> ../../../lib/jackson-jaxrs-json-provider.jar
          lrwxrwxrwx root root jackson-module-jaxb-annotations.jar -> ../../../lib/jackson-module-jaxb-annotations.jar
          lrwxrwxrwx root root jakarta.activation-api.jar -> ../../../lib/jakarta.activation-api.jar
          lrwxrwxrwx root root jakarta.annotation-api.jar -> ../../../lib/jakarta.annotation-api.jar
          lrwxrwxrwx root root jakarta.xml.bind-api.jar -> ../../../lib/jakarta.xml.bind-api.jar
          lrwxrwxrwx root root jboss-jaxrs-api_2.0_spec.jar -> ../../../lib/jboss-jaxrs-api_2.0_spec.jar
          lrwxrwxrwx root root jboss-logging.jar -> ../../../lib/jboss-logging.jar
          lrwxrwxrwx root root jss-tomcat-10.1.jar -> ../../../../../../usr/share/java/jss/jss-tomcat-10.1.jar
          lrwxrwxrwx root root jss-tomcat.jar -> ../../../../../../usr/share/java/jss/jss-tomcat.jar
          lrwxrwxrwx root root jss.jar -> ../../../lib/jss.jar
          lrwxrwxrwx root root ldapjdk.jar -> ../../../lib/ldapjdk.jar
          lrwxrwxrwx root root pki-common.jar -> ../../../lib/pki-common.jar
          lrwxrwxrwx root root pki-tomcat-10.1.jar -> ../../../../../../usr/share/java/pki/pki-tomcat-10.1.jar
          lrwxrwxrwx root root pki-tomcat.jar -> ../../../../../../usr/share/java/pki/pki-tomcat.jar
          lrwxrwxrwx root root resteasy-jackson2-provider.jar -> ../../../lib/resteasy-jackson2-provider.jar
          lrwxrwxrwx root root resteasy-jaxrs.jar -> ../../../lib/resteasy-jaxrs.jar
          -rw-r--r-- root root resteasy-servlet-initializer-x.y.z.Final.jar
          lrwxrwxrwx root root resteasy-servlet-initializer.jar -> resteasy-servlet-initializer-x.y.z.Final.jar
          EOF

          # normalize actual result:
          # - replace version number with x.y.z
          # - replace jss-tomcat-9.0.jar with jss-tomcat-10.1.jar
          # - replace pki-tomcat-9.0.jar with pki-tomcat-10.1.jar
          sed -e 's/-[0-9]*\.[0-9]*\.[0-9]*\.jar$/-x.y.z.jar/' \
              -e 's/-[0-9]*\.[0-9]*\.[0-9]*\.Final\.jar$/-x.y.z.Final.jar/' \
              -e 's/jss-tomcat-9.0.jar/jss-tomcat-10.1.jar/g' \
              -e 's/pki-tomcat-9.0.jar/pki-tomcat-10.1.jar/g' \
              output > actual

          diff expected actual

      - name: Check PKI server lib dir
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /usr/share/pki/server/lib \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          cat > expected << EOF
          lrwxrwxrwx root root slf4j-api.jar -> ../../lib/slf4j-api.jar
          lrwxrwxrwx root root slf4j-jdk14.jar -> ../../lib/slf4j-jdk14.jar
          EOF

          diff expected output

      - name: Check pki-server CLI help message
        run: |
          docker exec pki pki-server
          docker exec pki pki-server --help

          # TODO: validate output

      - name: Check pki-server CLI version
        run: |
          docker exec pki pki-server --version

          # TODO: validate output

      - name: Check pki-server CLI with wrong option
        run: |
          docker exec pki pki-server --wrong \
              > >(tee stdout) 2> >(tee stderr >&2) || true

          # TODO: validate output

      - name: Check pki-server CLI with wrong sub-command
        run: |
          docker exec pki pki-server wrong \
              > >(tee stdout) 2> >(tee stderr >&2) || true

          cat > expected << EOF
          ERROR: Invalid module "wrong".
          EOF

          diff expected stderr

      - name: Check pki-server create CLI help message
        run: |
          docker exec pki pki-server create --help

          # TODO: validate output

      - name: Create pki-tomcat server
        run: |
          docker exec pki pki-server create -v

      - name: Start pki-tomcat server
        run: |
          docker exec pki pki-server start --wait -v

      - name: Check pki-tomcat server base dir after installation
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          lrwxrwxrwx pkiuser pkiuser bin -> /usr/share/tomcat/bin
          drwxr-x--- pkiuser pkiuser common
          lrwxrwxrwx pkiuser pkiuser conf -> /etc/pki/pki-tomcat
          lrwxrwxrwx pkiuser pkiuser lib -> /usr/share/pki/server/lib
          lrwxrwxrwx pkiuser pkiuser logs -> /var/log/pki/pki-tomcat
          drwxr-x--- pkiuser pkiuser temp
          drwxr-x--- pkiuser pkiuser webapps
          drwxr-x--- pkiuser pkiuser work
          EOF

          diff expected output

      - name: Check pki-tomcat server conf dir after installation
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /etc/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- pkiuser pkiuser Catalina
          -rw-rw---- pkiuser pkiuser catalina.policy
          lrwxrwxrwx pkiuser pkiuser catalina.properties -> /usr/share/pki/server/conf/catalina.properties
          drwxr-x--- pkiuser pkiuser certs
          lrwxrwxrwx pkiuser pkiuser context.xml -> /etc/tomcat/context.xml
          lrwxrwxrwx pkiuser pkiuser logging.properties -> /usr/share/pki/server/conf/logging.properties
          -rw-rw---- pkiuser pkiuser server.xml
          -rw-rw---- pkiuser pkiuser tomcat.conf
          lrwxrwxrwx pkiuser pkiuser web.xml -> /etc/tomcat/web.xml
          EOF

          diff expected output

      - name: Check pki-tomcat server.xml
        if: always()
        run: |
          docker exec pki cat /etc/pki/pki-tomcat/server.xml

      - name: Check pki-tomcat tomcat.conf
        if: always()
        run: |
          docker exec pki cat /etc/pki/pki-tomcat/tomcat.conf

      - name: Check PKI server conf/Catalina/localhost dir after installation
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /etc/pki/pki-tomcat/Catalina/localhost \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          lrwxrwxrwx pkiuser pkiuser rewrite.config -> /usr/share/pki/server/conf/Catalina/localhost/rewrite.config
          EOF

          diff expected output

      - name: Check pki-tomcat server logs dir after installation
        if: ${{ fromJSON(env.FEDORA_VERSION) < 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/log/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- pkiuser pkiuser backup
          -rw-r--r-- pkiuser pkiuser localhost.$DATE.log
          -rw-r--r-- pkiuser pkiuser localhost_access_log.$DATE.txt
          EOF

          diff expected output

      - name: Check pki-tomcat server logs dir after installation
        if: ${{ fromJSON(env.FEDORA_VERSION) >= 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/log/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- pkiuser pkiuser backup
          -rw-r--r-- pkiuser pkiuser localhost_access_log.$DATE.txt
          EOF

          diff expected output

      - name: Check pki-tomcat webapps
        run: |
          docker exec pki pki-server webapp-find | tee output

          # there should be no webapps
          sed -n 's/^ *Webapp ID: *\(.*\)$/\1/p' output > actual
          diff /dev/null actual

      - name: Check pki-tomcat subsystems
        run: |
          docker exec pki pki-server subsystem-find | tee output

          # there should be no subsystems
          sed -n 's/^ *Subsystem ID: *\(.*\)$/\1/p' output > actual
          diff /dev/null actual

          # CA subsystem should not exist
          docker exec pki pki-server subsystem-show ca \
              > >(tee stdout) 2> >(tee stderr >&2) || true

          echo "ERROR: No ca subsystem in instance pki-tomcat." > expected
          diff expected stderr

          # create empty CA subsystem folder
          docker exec pki mkdir -p /var/lib/pki/pki-tomcat/ca

          # CA subsystem should not exist
          docker exec pki pki-server subsystem-show ca \
              > >(tee stdout) 2> >(tee stderr >&2) || true

          echo "ERROR: No ca subsystem in instance pki-tomcat." > expected
          diff expected stderr

          # remove CA subsystem folder
          docker exec pki rm -rf /var/lib/pki/pki-tomcat/ca

      - name: Check HTTP connection to pki-tomcat server
        run: |
          docker exec pki curl \
              --retry 60 \
              --retry-delay 0 \
              --retry-connrefused \
              -s \
              -k \
              -o /dev/null \
              http://pki.example.com:8080

      - name: Stop pki-tomcat server
        run: |
          docker exec pki pki-server stop --wait -v

      - name: Remove pki-tomcat server
        run: |
          docker exec pki pki-server remove -v

      - name: Check pki-tomcat server base dir after removal
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          lrwxrwxrwx pkiuser pkiuser conf -> /etc/pki/pki-tomcat
          lrwxrwxrwx pkiuser pkiuser logs -> /var/log/pki/pki-tomcat
          EOF

          diff expected output

      - name: Check pki-tomcat server conf dir after removal
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /etc/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- pkiuser pkiuser Catalina
          -rw-rw---- pkiuser pkiuser catalina.policy
          lrwxrwxrwx pkiuser pkiuser catalina.properties -> /usr/share/pki/server/conf/catalina.properties
          drwxr-x--- pkiuser pkiuser certs
          lrwxrwxrwx pkiuser pkiuser context.xml -> /etc/tomcat/context.xml
          lrwxrwxrwx pkiuser pkiuser logging.properties -> /usr/share/pki/server/conf/logging.properties
          -rw-rw---- pkiuser pkiuser server.xml
          -rw-rw---- pkiuser pkiuser tomcat.conf
          lrwxrwxrwx pkiuser pkiuser web.xml -> /etc/tomcat/web.xml
          EOF

          diff expected output

      - name: Check pki-tomcat server logs dir after removal
        if: ${{ fromJSON(env.FEDORA_VERSION) < 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/log/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- pkiuser pkiuser backup
          -rw-r--r-- pkiuser pkiuser localhost.$DATE.log
          -rw-r--r-- pkiuser pkiuser localhost_access_log.$DATE.txt
          EOF

          diff expected output

      - name: Check pki-tomcat server logs dir after removal
        if: ${{ fromJSON(env.FEDORA_VERSION) >= 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/log/pki/pki-tomcat \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- pkiuser pkiuser backup
          -rw-r--r-- pkiuser pkiuser localhost_access_log.$DATE.txt
          EOF

          diff expected output

      - name: Create tomcat@pki server
        run: |
          docker exec pki pki-server create tomcat@pki -v

      - name: Start tomcat@pki server
        run: |
          docker exec pki pki-server start tomcat@pki --wait -v

      - name: Check tomcat@pki server base dir after installation
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          lrwxrwxrwx tomcat tomcat bin -> /usr/share/tomcat/bin
          drwxr-x--- tomcat tomcat common
          drwxr-x--- tomcat tomcat conf
          lrwxrwxrwx tomcat tomcat lib -> /usr/share/pki/server/lib
          drwxr-x--- tomcat tomcat logs
          drwxr-x--- tomcat tomcat temp
          drwxr-x--- tomcat tomcat webapps
          drwxr-x--- tomcat tomcat work
          EOF

          diff expected output

      - name: Check tomcat@pki server conf dir after installation
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki/conf \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- tomcat tomcat Catalina
          -rw-rw---- tomcat tomcat catalina.policy
          lrwxrwxrwx tomcat tomcat catalina.properties -> /usr/share/pki/server/conf/catalina.properties
          drwxr-x--- tomcat tomcat certs
          lrwxrwxrwx tomcat tomcat context.xml -> /etc/tomcat/context.xml
          -rw-rw---- tomcat tomcat logging.properties
          -rw-rw---- tomcat tomcat server.xml
          -rw-rw---- tomcat tomcat tomcat.conf
          lrwxrwxrwx tomcat tomcat web.xml -> /etc/tomcat/web.xml
          EOF

          diff expected output

      - name: Check tomcat@pki server.xml
        if: always()
        run: |
          docker exec pki cat /var/lib/tomcats/pki/conf/server.xml

      - name: Check tomcat@pki tomcat.conf
        if: always()
        run: |
          docker exec pki cat /var/lib/tomcats/pki/conf/tomcat.conf

      - name: Check tomcat@pki server logs dir after installation
        if: ${{ fromJSON(env.FEDORA_VERSION) < 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki/logs \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- tomcat tomcat backup
          -rw-r--r-- tomcat tomcat catalina.$DATE.log
          -rw-r--r-- tomcat tomcat host-manager.$DATE.log
          -rw-r--r-- tomcat tomcat localhost.$DATE.log
          -rw-r--r-- tomcat tomcat localhost_access_log.$DATE.txt
          -rw-r--r-- tomcat tomcat manager.$DATE.log
          EOF

          diff expected output

      - name: Check tomcat@pki server logs dir after installation
        if: ${{ fromJSON(env.FEDORA_VERSION) >= 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki/logs \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- tomcat tomcat backup
          -rw-r--r-- tomcat tomcat catalina.$DATE.log
          -rw-r--r-- tomcat tomcat localhost_access_log.$DATE.txt
          EOF

          diff expected output

      - name: Check HTTP connection to tomcat@pki server
        run: |
          docker exec pki curl \
              --retry 60 \
              --retry-delay 0 \
              --retry-connrefused \
              -s \
              -k \
              -o /dev/null \
              http://pki.example.com:8080

      - name: Stop tomcat@pki server
        run: |
          docker exec pki pki-server stop tomcat@pki --wait -v

      - name: Remove tomcat@pki server
        run: |
          docker exec pki pki-server remove tomcat@pki -v

      - name: Check tomcat@pki server base dir after removal
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- tomcat tomcat conf
          drwxr-x--- tomcat tomcat logs
          EOF

          diff expected output

      - name: Check tomcat@pki server conf dir after removal
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki/conf \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- tomcat tomcat Catalina
          -rw-rw---- tomcat tomcat catalina.policy
          lrwxrwxrwx tomcat tomcat catalina.properties -> /usr/share/pki/server/conf/catalina.properties
          drwxr-x--- tomcat tomcat certs
          lrwxrwxrwx tomcat tomcat context.xml -> /etc/tomcat/context.xml
          -rw-rw---- tomcat tomcat logging.properties
          -rw-rw---- tomcat tomcat server.xml
          -rw-rw---- tomcat tomcat tomcat.conf
          lrwxrwxrwx tomcat tomcat web.xml -> /etc/tomcat/web.xml
          EOF

          diff expected output

      - name: Check tomcat@pki server logs dir after removal
        if: ${{ fromJSON(env.FEDORA_VERSION) < 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki/logs \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- tomcat tomcat backup
          -rw-r--r-- tomcat tomcat catalina.$DATE.log
          -rw-r--r-- tomcat tomcat host-manager.$DATE.log
          -rw-r--r-- tomcat tomcat localhost.$DATE.log
          -rw-r--r-- tomcat tomcat localhost_access_log.$DATE.txt
          -rw-r--r-- tomcat tomcat manager.$DATE.log
          EOF

          diff expected output

      - name: Check tomcat@pki server logs dir after removal
        if: ${{ fromJSON(env.FEDORA_VERSION) >= 43 }}
        run: |
          # check file types, owners, and permissions
          docker exec pki ls -l /var/lib/tomcats/pki/logs \
              | sed \
                  -e '/^total/d' \
                  -e 's/^\(\S*\) *\S* *\(\S*\) *\(\S*\) *\S* *\S* *\S* *\S* *\(.*\)$/\1 \2 \3 \4/' \
              | tee output

          DATE=$(date +'%Y-%m-%d')

          # TODO: review permissions
          cat > expected << EOF
          drwxr-x--- tomcat tomcat backup
          -rw-r--r-- tomcat tomcat catalina.$DATE.log
          -rw-r--r-- tomcat tomcat localhost_access_log.$DATE.txt
          EOF

          diff expected output
