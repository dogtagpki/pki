name: Quarkus Build Test

on: workflow_call

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Retrieve PKI images
        uses: actions/cache@v4
        with:
          key: pki-images-${{ github.sha }}
          path: pki-images.tar

      - name: Load PKI images
        run: docker load --input pki-images.tar

      - name: Build Quarkus modules
        run: |
          docker run --name quarkus-builder pki-quarkus-builder \
              bash -c "ls -la /root/pki/base/*/target/quarkus-app/quarkus-run.jar 2>/dev/null || true"

      - name: Verify build artifacts
        run: |
          for sub in est acme ocsp kra tks tps ca; do
            echo "Checking ${sub}-quarkus build artifacts..."
            docker run --rm pki-quarkus-builder \
                test -f /root/pki/base/${sub}-quarkus/target/quarkus-app/quarkus-run.jar
            echo "  OK: ${sub}-quarkus/target/quarkus-app/quarkus-run.jar exists"
          done

      - name: Verify Quarkus runner image
        run: |
          echo "Checking pki-quarkus-runner image..."
          for sub in est acme ocsp kra tks tps ca; do
            docker run --rm pki-quarkus-runner \
                test -d /usr/share/pki/quarkus/${sub}
            echo "  OK: /usr/share/pki/quarkus/${sub} exists"
          done
